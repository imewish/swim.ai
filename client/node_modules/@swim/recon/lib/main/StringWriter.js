import { __extends } from "tslib";
import { WriterException, Writer, Utf8, Base16 } from "@swim/codec";
var StringWriter = (function (_super) {
    __extends(StringWriter, _super);
    function StringWriter(string, index, escape, step) {
        var _this = _super.call(this) || this;
        _this._string = string;
        _this._index = index;
        _this._escape = escape;
        _this._step = step;
        return _this;
    }
    StringWriter.prototype.pull = function (output) {
        return StringWriter.write(output, this._string, this._index, this._escape, this._step);
    };
    StringWriter.sizeOf = function (string) {
        var size = 0;
        size += 1;
        for (var i = 0, n = string.length; i < n; i = string.offsetByCodePoints(i, 1)) {
            var c = string.codePointAt(i);
            if (c === void 0) {
                c = string.charCodeAt(i);
            }
            if (c === 34 || c === 92 || c === 8 || c === 12
                || c === 10 || c === 13 || c === 9) {
                size += 2;
            }
            else if (c < 0x20) {
                size += 6;
            }
            else {
                size += Utf8.sizeOf(c);
            }
        }
        size += 1;
        return size;
    };
    StringWriter.write = function (output, string, index, escape, step) {
        if (index === void 0) { index = 0; }
        if (escape === void 0) { escape = 0; }
        if (step === void 0) { step = 1; }
        if (step === 1 && output.isCont()) {
            output = output.write(34);
            step = 2;
        }
        var length = string.length;
        while (step >= 2 && step <= 8 && output.isCont()) {
            if (step === 2) {
                if (index < length) {
                    var c = string.codePointAt(index);
                    if (c === void 0) {
                        c = string.charCodeAt(index);
                    }
                    index = string.offsetByCodePoints(index, 1);
                    if (c === 34 || c === 92) {
                        output = output.write(92);
                        escape = c;
                        step = 3;
                    }
                    else if (c === 8) {
                        output = output.write(92);
                        escape = 98;
                        step = 3;
                    }
                    else if (c === 12) {
                        output = output.write(92);
                        escape = 102;
                        step = 3;
                    }
                    else if (c === 10) {
                        output = output.write(92);
                        escape = 110;
                        step = 3;
                    }
                    else if (c === 13) {
                        output = output.write(92);
                        escape = 114;
                        step = 3;
                    }
                    else if (c === 9) {
                        output = output.write(92);
                        escape = 116;
                        step = 3;
                    }
                    else if (c < 0x20) {
                        output = output.write('\\');
                        escape = c;
                        step = 4;
                    }
                    else {
                        output = output.write(c);
                    }
                }
                else {
                    step = 9;
                    break;
                }
            }
            else if (step === 3) {
                output = output.write(escape);
                escape = 0;
                step = 2;
            }
            else if (step === 4) {
                output = output.write(117);
                step = 5;
            }
            else if (step === 5) {
                output = output.write(Base16.uppercase().encodeDigit((escape >>> 12) & 0xf));
                step = 6;
            }
            else if (step === 6) {
                output = output.write(Base16.uppercase().encodeDigit((escape >>> 8) & 0xf));
                step = 7;
            }
            else if (step === 7) {
                output = output.write(Base16.uppercase().encodeDigit((escape >>> 4) & 0xf));
                step = 8;
            }
            else if (step === 8) {
                output = output.write(Base16.uppercase().encodeDigit(escape & 0xf));
                escape = 0;
                step = 2;
            }
        }
        if (step === 9 && output.isCont()) {
            output = output.write(34);
            return Writer.done();
        }
        if (output.isDone()) {
            return Writer.error(new WriterException("truncated"));
        }
        else if (output.isError()) {
            return Writer.error(output.trap());
        }
        return new StringWriter(string, index, escape, step);
    };
    return StringWriter;
}(Writer));
export { StringWriter };
//# sourceMappingURL=StringWriter.js.map