import { __extends } from "tslib";
import { Parser, Diagnostic, Unicode, Base16 } from "@swim/codec";
import { Recon } from "./Recon";
var NumberParser = (function (_super) {
    __extends(NumberParser, _super);
    function NumberParser(recon, sign, value, mode, step) {
        var _this = _super.call(this) || this;
        _this._recon = recon;
        _this._sign = sign;
        _this._value = value;
        _this._mode = mode;
        _this._step = step;
        return _this;
    }
    NumberParser.prototype.feed = function (input) {
        return NumberParser.parse(input, this._recon, this._sign, this._value, this._mode, this._step);
    };
    NumberParser.parse = function (input, recon, sign, value, mode, step) {
        if (sign === void 0) { sign = 1; }
        if (value === void 0) { value = 0; }
        if (mode === void 0) { mode = 2; }
        if (step === void 0) { step = 1; }
        var c = 0;
        if (step === 1) {
            while (input.isCont() && (c = input.head(), Recon.isWhitespace(c))) {
                input = input.step();
            }
            if (input.isCont()) {
                if (c === 45) {
                    input = input.step();
                    sign = -1;
                }
                step = 2;
            }
            else if (input.isDone()) {
                return Parser.error(Diagnostic.expected("number", input));
            }
        }
        if (step === 2) {
            if (input.isCont()) {
                c = input.head();
                if (c === 48) {
                    input = input.step();
                    step = 4;
                }
                else if (c >= 49 && c <= 57) {
                    input = input.step();
                    value = sign * (c - 48);
                    step = 3;
                }
                else {
                    return Parser.error(Diagnostic.expected("digit", input));
                }
            }
            else if (input.isDone()) {
                return Parser.error(Diagnostic.expected("digit", input));
            }
        }
        if (step === 3) {
            while (input.isCont()) {
                c = input.head();
                if (c >= 48 && c <= 57) {
                    var newValue = 10 * value + sign * (c - 48);
                    if (-9007199254740991 <= newValue && newValue <= 9007199254740992) {
                        value = newValue;
                        input = input.step();
                    }
                    else {
                        return Parser.error(Diagnostic.message("integer overflow", input));
                    }
                }
                else {
                    break;
                }
            }
            if (input.isCont()) {
                step = 4;
            }
            else if (input.isDone()) {
                return Parser.done(recon.num(value));
            }
        }
        if (step === 4) {
            if (input.isCont()) {
                c = input.head();
                if (mode > 0 && c === 46 || mode > 1 && (c === 69 || c === 101)) {
                    var output = Unicode.stringOutput();
                    if (sign < 0 && value === 0) {
                        output = output.write(45).write(48);
                    }
                    else {
                        output = output.write("" + value);
                    }
                    return DecimalParser.parse(input, recon, output, mode);
                }
                else if (c === 120 && sign > 0 && value === 0) {
                    input = input.step();
                    return HexadecimalParser.parse(input, recon);
                }
                else {
                    return Parser.done(recon.num(value));
                }
            }
            else if (input.isDone()) {
                return Parser.done(recon.num(value));
            }
        }
        return new NumberParser(recon, sign, value, mode, step);
    };
    NumberParser.parseInteger = function (input, recon) {
        return NumberParser.parse(input, recon, void 0, void 0, 0);
    };
    NumberParser.parseDecimal = function (input, recon) {
        return NumberParser.parse(input, recon, void 0, void 0, 1);
    };
    return NumberParser;
}(Parser));
export { NumberParser };
var DecimalParser = (function (_super) {
    __extends(DecimalParser, _super);
    function DecimalParser(recon, output, mode, step) {
        var _this = _super.call(this) || this;
        _this._recon = recon;
        _this._output = output;
        _this._mode = mode;
        _this._step = step;
        return _this;
    }
    DecimalParser.prototype.feed = function (input) {
        return DecimalParser.parse(input, this._recon, this._output, this._mode, this._step);
    };
    DecimalParser.parse = function (input, recon, output, mode, step) {
        if (mode === void 0) { mode = 2; }
        if (step === void 0) { step = 1; }
        var c = 0;
        if (step === 1) {
            if (input.isCont()) {
                c = input.head();
                if (c === 46) {
                    input = input.step();
                    output = output.write(c);
                    step = 2;
                }
                else if (mode > 1 && (c === 69 || c === 101)) {
                    input = input.step();
                    output = output.write(c);
                    step = 5;
                }
                else {
                    return Parser.error(Diagnostic.expected("decimal or exponent", input));
                }
            }
            else if (input.isDone()) {
                return Parser.error(Diagnostic.expected("decimal or exponent", input));
            }
        }
        if (step === 2) {
            if (input.isCont()) {
                c = input.head();
                if (c >= 48 && c <= 57) {
                    input = input.step();
                    output = output.write(c);
                    step = 3;
                }
                else {
                    return Parser.error(Diagnostic.expected("digit", input));
                }
            }
            else if (input.isDone()) {
                return Parser.error(Diagnostic.expected("digit", input));
            }
        }
        if (step === 3) {
            while (input.isCont()) {
                c = input.head();
                if (c >= 48 && c <= 57) {
                    input = input.step();
                    output = output.write(c);
                }
                else {
                    break;
                }
            }
            if (input.isCont()) {
                if (mode > 1) {
                    step = 4;
                }
                else {
                    return Parser.done(recon.num(output.bind()));
                }
            }
            else if (input.isDone()) {
                return Parser.done(recon.num(output.bind()));
            }
        }
        if (step === 4) {
            c = input.head();
            if (c === 69 || c === 101) {
                input = input.step();
                output = output.write(c);
                step = 5;
            }
            else {
                return Parser.done(recon.num(output.bind()));
            }
        }
        if (step === 5) {
            if (input.isCont()) {
                c = input.head();
                if (c === 43 || c === 45) {
                    input = input.step();
                    output = output.write(c);
                }
                step = 6;
            }
            else if (input.isDone()) {
                return Parser.error(Diagnostic.unexpected(input));
            }
        }
        if (step === 6) {
            if (input.isCont()) {
                c = input.head();
                if (c >= 48 && c <= 57) {
                    input = input.step();
                    output = output.write(c);
                    step = 7;
                }
                else {
                    return Parser.error(Diagnostic.expected("digit", input));
                }
            }
            else if (input.isDone()) {
                return Parser.error(Diagnostic.expected("digit", input));
            }
        }
        if (step === 7) {
            while (input.isCont()) {
                c = input.head();
                if (c >= 48 && c <= 57) {
                    input = input.step();
                    output = output.write(c);
                }
                else {
                    break;
                }
            }
            if (!input.isEmpty()) {
                return Parser.done(recon.num(output.bind()));
            }
        }
        return new DecimalParser(recon, output, mode, step);
    };
    return DecimalParser;
}(Parser));
var HexadecimalParser = (function (_super) {
    __extends(HexadecimalParser, _super);
    function HexadecimalParser(recon, value, size) {
        var _this = _super.call(this) || this;
        _this._recon = recon;
        _this._value = value;
        _this._size = size;
        return _this;
    }
    HexadecimalParser.prototype.feed = function (input) {
        return HexadecimalParser.parse(input, this._recon, this._value, this._size);
    };
    HexadecimalParser.parse = function (input, recon, value, size) {
        if (value === void 0) { value = 0; }
        if (size === void 0) { size = 0; }
        var c = 0;
        while (input.isCont()) {
            c = input.head();
            if (Base16.isDigit(c)) {
                input = input.step();
                value = 16 * value + Base16.decodeDigit(c);
                size += 1;
            }
            else {
                break;
            }
        }
        if (!input.isEmpty()) {
            if (size > 0) {
                if (size <= 8) {
                    return Parser.done(recon.uint32(value));
                }
                else {
                    return Parser.done(recon.uint64(value));
                }
            }
            else {
                return Parser.error(Diagnostic.expected("hex digit", input));
            }
        }
        return new HexadecimalParser(recon, value, size);
    };
    return HexadecimalParser;
}(Parser));
//# sourceMappingURL=NumberParser.js.map